<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Disc of Serendipity</title>
	</head>
	<body>
		<h1>Disc of Serendipity</h1>
		<canvas id="canvas" width="800" height="600"></canvas>
		<button type="button" name="button" onclick="spinWheel();">Spin</button>

		<script src="assets/js/wheel_physics.js" charset="utf-8"></script>
		<script src="assets/js/wheel_draw.js" charset="utf-8"></script>
		<script src="assets/js/letterboard_draw.js" charset="utf-8"></script>
		<script src="assets/js/before_and_after.js" charset="utf-8"></script>
<script type="text/javascript">
	var canvas = document.getElementById("canvas");
	var ctx = canvas.getContext("2d");

var WheelGame = function(phrases) {
	this.state = "NEW_WORD";
	this.states = ["NEW_WORD", "CHECK_FUNDS", "BUY_VOWEL", "CHECK_VOWEL", "SPINNING", "BANKRUPT", "CHOOSE_CONSONANT", "CHECK_CONSONANT", "CHECK_PHRASE"];
	this.allowedTransitions = {
		"NEW_WORD": ["CHECK_FUNDS"],
		"CHECK_FUNDS": ["BUY_VOWEL", "SPINNING"],
		"BUY_VOWEL": ["CHECK_VOWEL"],
		"CHECK_VOWEL": ["CHECK_FUNDS", "CHECK_PHRASE"],
		"SPINNING": ["BANKRUPT", "CHOOSE_CONSONANT"],
		"BANKRUPT": ["NEW_WORD"],
		"CHOOSE_CONSONANT": ["CHECK_CONSONANT"],
		"CHECK_CONSONANT": ["CHECK_FUNDS", "CHECK_PHRASE"],
		"CHECK_PHRASE": ["CHECK_FUNDS", "NEW_WORD"]
	};

	this.savedFunds = 0;
	this.currentWordFunds = 0;
	this.lastSpin = 0;

	this.canTransitionTo = function(nextState) {
		var allowed = this.allowedTransitions[this.state];
		if (allowed === undefined) { throw "Game is in invalid state" }
		for (var i = 0; i < allowed.length; i++) {
			if (allowed[i] == nextState) { return true; }
		}
		return false;
	}

	this.handle = function() {

	}
}

	var game = new WheelGame();

	var letterBoard = new LetterBoard(24, 30, 10);
	bna[0][0] = "_ ____ ___"; // TODO: remove debug
	letterBoard.phrase = bna[0]; // TODO: choose random phrase

	var wp = new WheelPhysics(0);
	var wheelAnimationStart;
	var wheelIsSpinning = false;
	var wheel = new Wheel(wp);

	function drawEverything() {
		canvas.width = canvas.width;
		letterBoard.update();
		wheel.update();
		ctx.drawImage(letterBoard.canvas, 0, 0);
		ctx.drawImage(wheel.canvas, letterBoard.canvas.width, 0);
	};

	function renderWheelAnimation() {
		var delta = Date.now() - wheelAnimationStart;
		wheel.wheelPhysics.step(delta / 1000);

		drawEverything();
		if (Math.abs(wheel.wheelPhysics.omega) > 0.01) {
			wheelAnimationStart = Date.now();
			requestAnimationFrame(renderWheelAnimation);
		} else {
			wheelIsSpinning = false;
		}
	};

	function spinWheel() {
		if (!wheelIsSpinning) {
			wheelIsSpinning = true;
			wheel.wheelPhysics.omega = Math.random()*4 + 4;
			wheelAnimationStart = Date.now();
			renderWheelAnimation();
		}
	};

	drawEverything();

</script>
	</body>
</html>
