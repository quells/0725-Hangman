<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<link rel="stylesheet" href="assets/css/reset.css">
		<link href="https://fonts.googleapis.com/css?family=Passion+One:400,900" rel="stylesheet">
		<link rel="stylesheet" href="assets/css/style.css">
		<title>Disc of Serendipity</title>
	</head>
	<body>
		<div id="container">
			<h1>DISC OF SERENDIPITY</h1>
			<div id="gameWrapper">
				<canvas id="canvas" width="800" height="350"></canvas>
				<button id="spinButton" class="button" onmouseup="spinWheel();">SPIN</button>
			</div>
			<section id="scoreboard">
				<h2 id="score"></h2>
				<h2 id="letterValue"></h2>
				<p id="prompt"></p>
				<p id="guessedLetters"></p>
			</section>
		</div>

		<script src="assets/js/utility.js" charset="utf-8"></script>
		<script src="assets/js/wheel_physics.js" charset="utf-8"></script>
		<script src="assets/js/wheel_draw.js" charset="utf-8"></script>
		<script src="assets/js/letterboard_draw.js" charset="utf-8"></script>
		<script src="assets/js/before_and_after.js" charset="utf-8"></script>
<script type="text/javascript">
	var canvas = document.getElementById("canvas");
	var ctx = canvas.getContext("2d");

var WheelGame = function(phrases) {
	this.phrases = phrases;
	this.currentPhrase = [];
	this.displayPhrase = [];

	this.state = "NEW_WORD";
	this.states = ["NEW_WORD", "CHECK_FUNDS", "BUY_VOWEL", "CHECK_VOWEL", "SPINNING", "BANKRUPT", "CHOOSE_CONSONANT", "CHECK_CONSONANT", "CHECK_PHRASE"];
	this.allowedTransitions = {
		"NEW_WORD": ["CHECK_FUNDS"],
		"CHECK_FUNDS": ["BUY_VOWEL", "SPINNING"],
		"BUY_VOWEL": ["CHECK_VOWEL"],
		"CHECK_VOWEL": ["CHECK_FUNDS", "CHECK_PHRASE"],
		"SPINNING": ["BANKRUPT", "CHOOSE_CONSONANT"],
		"BANKRUPT": ["NEW_WORD"],
		"CHOOSE_CONSONANT": ["CHECK_CONSONANT"],
		"CHECK_CONSONANT": ["CHECK_FUNDS", "CHECK_PHRASE"],
		"CHECK_PHRASE": ["CHECK_FUNDS", "NEW_WORD"]
	};

	this.spinButton = undefined;

	this.savedFunds = 0;
	this.currentWordFunds = 0;
	this.lastSpin = 0;
	this.canBuyVowel = false;
	this.canSpinWheel = false;
	this.prompt = "";
	this.guessedLetters = [];
	this.letterToCheck = -1;

	this.canTransitionTo = function(nextState) {
		var allowed = this.allowedTransitions[this.state];
		if (allowed === undefined) { throw "Game is in invalid state"; }
		for (var i = 0; i < allowed.length; i++) {
			if (allowed[i] == nextState) { return true; }
		}
		return false;
	};

	this.transitionTo = function(nextState) {
		if (this.canTransitionTo(nextState)) {
			this.state = nextState;
			this.handleCurrentState();
			document.drawEverything();
		} else {
			throw "Cannot transition from " + this.state + "to " + nextState
		}
	};

	this.handleCurrentState = function() {
		switch (this.state) {
			case "NEW_WORD":
				if (this.phrases.length < 1) { throw "Out of phrases"; }
				var index = randomIndex(this.phrases);
				var rai = removeAtIndex(this.phrases, index);
				this.phrases = rai.remaining;
				this.currentPhrase = rai.removed;
				var displayPhrase = [];
				if (this.currentPhrase === undefined) { throw "Invalid phrase"; }
				this.currentPhrase.forEach(function(chunk) {
					var displayChunk = "";
					for (var i = 0; i < chunk.length; i++) {
						var char = chunk.charAt(i);
						if (char == " ") {
							displayChunk += char;
						} else {
							displayChunk += "_";
						}
					}
					displayPhrase.push(displayChunk);
				});
				this.displayPhrase = displayPhrase;
				this.guessedLetters = new Array(26).fill(false);
				this.transitionTo("CHECK_FUNDS");
				break;
			case "CHECK_FUNDS":
				if (this.currentWordFunds + this.savedFunds >= 250) {
					this.canBuyVowel = true;
					this.prompt = "Spin the wheel or buy a vowel.";
				} else {
					this.prompt = "Spin the wheel.";
				}
				this.canSpinWheel = true;
				this.spinButton.classList.remove("inactive");
				break;
			case "SPINNING":
				if (this.lastSpin == "BANKRUPT") {
					this.transitionTo("BANKRUPT");
				} else {
					this.transitionTo("CHOOSE_CONSONANT");
				}
				break;
			case "CHOOSE_CONSONANT":
				this.prompt = "Choose a consonant.";
				break;
			case "CHECK_CONSONANT":
				if (this.letterToCheck < 0) {
					throw "Game is in invalid state";
				}
				var didFindLetter = false;
				var letter = String.fromCharCode(this.letterToCheck + 97);
				console.log(letter);
				console.log(this.currentPhrase);
				for (var j = 0; j < this.currentPhrase.length; j++) {
					var chunk = this.currentPhrase[j];
					var displayChunk = this.displayPhrase[j];
					for (var i = 0; i < chunk.length; i++) {
						if (chunk.charAt(i) == letter) {
							displayChunk = replaceCharAt(displayChunk, i, letter);
							didFindLetter = true;
							this.currentWordFunds += this.lastSpin;
						}
					}
					this.displayPhrase[j] = displayChunk;
				}
				if (didFindLetter) {
					this.transitionTo("CHECK_PHRASE");
				} else {
					this.transitionTo("CHECK_FUNDS");
				}
				break;
			case "CHECK_PHRASE":
				var currentPhrase = this.currentPhrase.join(" ");
				var displayPhrase = this.displayPhrase.join(" ");
				if (currentPhrase == displayPhrase) {
					this.savedFunds += this.currentWordFunds;
					this.currentWordFunds = 0;
					this.transitionTo("NEW_WORD");
				} else {
					this.transitionTo("CHECK_FUNDS");
				}
				break;
			default:
				throw "Game is in invalid state";
				break;
		}
	};

	this.handle = function(event) {
		switch (this.state) {
			case "CHOOSE_CONSONANT":
				if (65 <= event.keyCode && event.keyCode <= 90) {
					var char = event.keyCode - 65;
					switch (char) {
						case 0:
						case 4:
						case 8:
						case 14:
						case 20:
							break;
						default:
							this.letterToCheck = char;
							this.transitionTo("CHECK_CONSONANT");
							break;
					}
				}
				break;
			default:
				break;
		}
	};
};

	var game = new WheelGame(bna);
	game.spinButton = document.getElementById("spinButton");

	var letterBoard = new LetterBoard(8*4, 8*5, 20);

	var wp = new WheelPhysics(0);
	var wheelAnimationStart;
	var wheel = new Wheel(wp);

	var spinButton = document.getElementById("spinButton");
	spinButton.style.marginLeft = (letterBoard.canvas.width + 125) + "px";
	spinButton.style.marginTop = (wheel.canvas.height + 40) + "px";

	var Background = function(w, h) {
		this.canvas = document.createElement("canvas");
		this.canvas.width = w;
		this.canvas.height = h;

		var ctx = this.canvas.getContext("2d");
		ctx.fillStyle = "#107";
		ctx.fillRect(0, 0, w, h);

		ctx.strokeStyle = "#3ac";
		ctx.lineWidth = 4;

		ctx.beginPath();
		ctx.arc(w*0.4, w*0.75+10, w*0.75, 0, 2*Math.PI);
		ctx.arc(w*0.6, w*0.80+60, w*0.80, 0, 2*Math.PI);
		ctx.arc(w*0.35, w*1.18, w, 0, 2*Math.PI);
		ctx.stroke();

		ctx.strokeStyle = "#b8f";
		ctx.lineWidth = 2;

		ctx.beginPath();
		ctx.arc(w*0.4, w*0.75+10, w*0.73, 0, 2*Math.PI);
		ctx.arc(w*0.6, w*0.80+50, w*0.75, 0, 2*Math.PI);
		ctx.stroke();
	}
	var background = new Background(canvas.width, canvas.height);

	document.drawEverything = function() {
		canvas.width = canvas.width;
		letterBoard.phrase = game.displayPhrase;
		letterBoard.update();
		wheel.update();
		ctx.drawImage(background.canvas, 0, 0);
		ctx.drawImage(letterBoard.canvas, 30, 70);
		ctx.drawImage(wheel.canvas, letterBoard.canvas.width + 50, 50);

		document.getElementById("score").innerHTML = "Score: $" + (game.savedFunds + game.currentWordFunds);
		if (game.lastSpin == "BANKRUPT") {
			document.getElementById("letterValue").innerHTML = "Letter Value: $0";
		} else {
			document.getElementById("letterValue").innerHTML = "Letter Value: $" + game.lastSpin;
		}
		document.getElementById("prompt").innerHTML = game.prompt;

		var guessedLetters = new Array();
		for (var i = 0; i < 26; i++) {
			if (game.guessedLetters[i]) {
				guessedLetters.push(String.fromCharCode(i+65)); // 65 = A, 97 = a
			}
		}
		document.getElementById("guessedLetters").innerHTML = guessedLetters.join(", ");
	};

	function renderWheelAnimation() {
		var delta = Date.now() - wheelAnimationStart;
		wheel.wheelPhysics.step(delta / 1000);

		document.drawEverything();
		if (Math.abs(wheel.wheelPhysics.omega) > 0.01) {
			wheelAnimationStart = Date.now();
			requestAnimationFrame(renderWheelAnimation);
		} else {
			// spinButton.classList.remove("inactive");
			// wheelIsSpinning = false;
			game.lastSpin = wheel.currentValue();
			game.transitionTo("SPINNING");
		}
	};

	function spinWheel() {
		if (game.canSpinWheel) {
			spinButton.classList.add("inactive");
			game.canSpinWheel = false;
			wheel.wheelPhysics.omega = Math.random()*4 + 4;
			wheelAnimationStart = Date.now();
			renderWheelAnimation();
		}
	};

	document.onkeyup = function(event) {
		game.handle(event);
	}

	game.handleCurrentState();

</script>
	</body>
</html>
